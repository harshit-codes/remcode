name: Development Dashboard

on:
  schedule:
    # Update dashboard every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  
jobs:
  generate-dashboard:
    name: Generate Development Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd docs
          npm install --silent
          
      - name: Generate session metrics
        run: |
          cd docs
          npm run session-summary
          
      - name: Create development dashboard
        run: |
          cd docs
          
          # Extract metrics for dashboard
          TOTAL_SESSIONS=$(grep "Total Sessions:" COMPREHENSIVE_SUMMARY.md | grep -o '[0-9]\+' | head -1 || echo "0")
          TOTAL_TIME=$(grep "Total Development Time:" COMPREHENSIVE_SUMMARY.md | grep -o '[0-9]\+\.[0-9]\+' | head -1 || echo "0.0")
          COMPLETION_RATE=$(grep "Completion Rate:" COMPREHENSIVE_SUMMARY.md | grep -o '[0-9]\+\.[0-9]\+' | head -1 || echo "0.0")
          RESOLUTION_RATE=$(grep "Issue Resolution Rate:" COMPREHENSIVE_SUMMARY.md | grep -o '[0-9]\+\.[0-9]\+' | head -1 || echo "0.0")
          
          # Get recent focus areas
          RECENT_FOCUS=$(grep -A 5 "Recent Focus Areas" PROGRESS_ANALYSIS.md | tail -n 3 | head -n 1 | sed 's/^[0-9]*\. [‚úÖüîÑüö´] //' || echo "Development in progress")
          
          # Create dashboard markdown
          cat > DEVELOPMENT_DASHBOARD.md << EOF
          # üìä Development Dashboard
          
          **Last Updated**: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          ## üéØ Quick Stats
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | üìà Total Sessions | $TOTAL_SESSIONS | ![Sessions](https://img.shields.io/badge/Sessions-$TOTAL_SESSIONS-blue) |
          | ‚è±Ô∏è Development Time | ${TOTAL_TIME}h | ![Time](https://img.shields.io/badge/Time-${TOTAL_TIME}h-green) |
          | ‚úÖ Completion Rate | ${COMPLETION_RATE}% | ![Completion](https://img.shields.io/badge/Completion-${COMPLETION_RATE}%25-brightgreen) |
          | üîß Resolution Rate | ${RESOLUTION_RATE}% | ![Resolution](https://img.shields.io/badge/Resolution-${RESOLUTION_RATE}%25-success) |
          
          ## üéØ Current Focus
          
          **${RECENT_FOCUS}**
          
          ## üìà Weekly Progress
          
          \`\`\`mermaid
          gitgraph
              commit id: "Session System"
              commit id: "MCP Integration"  
              commit id: "CI/CD Automation"
              commit id: "Dashboard"
          \`\`\`
          
          ## üîÑ Automation Status
          
          | Component | Status | Last Run |
          |-----------|--------|----------|
          | Session Validation | ‚úÖ Active | $(date -u +"%Y-%m-%d %H:%M") |
          | Insights Generation | ‚úÖ Active | $(date -u +"%Y-%m-%d %H:%M") |
          | Dashboard Updates | ‚úÖ Active | $(date -u +"%Y-%m-%d %H:%M") |
          | Trend Analysis | ‚úÖ Active | $(date -u +"%Y-%m-%d %H:%M") |
          
          ## üìä Health Indicators
          
          - **üü¢ Data Quality**: CSV validation passing
          - **üü¢ Analysis Pipeline**: All reports generating successfully
          - **üü¢ Automation**: CI/CD workflows operational
          - **üü¢ Insights**: Comprehensive analytics available
          
          ---
          
          **üîó Quick Links:**
          - [üìà Progress Analysis](./PROGRESS_ANALYSIS.md)
          - [üö´ Blockers Analysis](./BLOCKERS_ANALYSIS.md)  
          - [üèóÔ∏è Codebase Analysis](./CODEBASE_ANALYSIS.md)
          - [üìã Comprehensive Summary](./COMPREHENSIVE_SUMMARY.md)
          EOF
          
          echo "üìä Generated development dashboard"
          
      - name: Create README badges
        run: |
          cd docs
          
          # Create badges for README
          cat > BADGES.md << 'EOF'
          <!-- Development Status Badges -->
          ![Sessions](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/harshit-codes/remcode/main/docs/session-metrics.json&query=$.total_sessions&label=Sessions&color=blue)
          ![Development Time](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/harshit-codes/remcode/main/docs/session-metrics.json&query=$.total_time_hours&label=Dev%20Time&suffix=h&color=green)
          ![Completion Rate](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/harshit-codes/remcode/main/docs/session-metrics.json&query=$.completion_rate&label=Completion&suffix=%25&color=brightgreen)
          ![Resolution Rate](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/harshit-codes/remcode/main/docs/session-metrics.json&query=$.resolution_rate&label=Resolution&suffix=%25&color=success)
          ![Last Updated](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/harshit-codes/remcode/main/docs/session-metrics.json&query=$.last_updated&label=Updated&color=lightgrey)
          EOF
          
          echo "üè∑Ô∏è Generated badges for README"
          
      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Commit dashboard
        run: |
          if git diff --quiet docs/DEVELOPMENT_DASHBOARD.md docs/BADGES.md; then
            echo "üìã No dashboard changes"
          else
            git add docs/DEVELOPMENT_DASHBOARD.md docs/BADGES.md
            git commit -m "chore: Update development dashboard

            - Refreshed development metrics and status
            - Updated automation health indicators
            - Generated latest session insights badges
            
            Generated by: Development Dashboard Automation"
            git push
            echo "‚úÖ Dashboard updated and pushed"
          fi
